# Auth ID Mapping Fix

## Problem

The application has two different ID systems:
1. **Supabase Auth IDs**: Generated by Supabase Auth when users sign in (e.g., `556acc47-f94f-4e53-b427-592491e9e5a8`)
2. **Database User IDs**: Predefined IDs in the `users` table (e.g., `11111117-1111-1111-1111-111111111111`)

This mismatch was causing authorization failures when students tried to access their message threads because RLS policies were checking `auth.uid()` against the database user IDs.

## Solution

### 1. Database Functions

Created two helper functions in migration `007_fix_auth_id_mapping.sql`:

- `get_user_id_from_auth()`: Maps the authenticated user to their database user ID by matching email
- `is_thread_participant()`: Checks if the current user is a participant in a thread

### 2. Updated RLS Policies

All message thread and message RLS policies now use these functions instead of directly comparing `auth.uid()`:

```sql
-- Example: Users can view their own threads
CREATE POLICY "Users can view their own threads" ON message_threads
    FOR SELECT USING (
        is_thread_participant(student_id, teacher_id)
    );
```

### 3. Client-Side Updates

- **AuthContext**: Already provides the database user ID in the `user` object
- **AIChat**: Uses the database user ID from context for thread operations
- **AI Store**: Updated to fetch database user ID by email before operations
- **Message Service**: Removed auth user validation since RLS handles it

## Testing

Run the test script to verify students can only see their own threads:

```bash
node scripts/test-student-threads.js
```

## Key Points

1. **Students can only see their own message threads**: RLS policies ensure this
2. **No cross-student visibility**: Each student's threads are isolated
3. **Teachers can see threads with their students**: Proper role-based access
4. **Automatic thread creation**: When a student opens AI chat, a thread is created with their teacher

## Deployment

To deploy these changes:

1. Run the new migration in Supabase:
   ```bash
   supabase db push
   ```

2. Deploy the updated client code

3. Test with different student accounts to verify isolation 